{% extends 'app1/base.html' %}

{% block title %}طراح جریان کار - {{ template.name }}{% endblock %}

{% block extra_css %}
<style>
    #flow-designer-canvas {
        width: 100%;
        height: 600px;
        background-color: #f5f5f5;
        position: relative;
        overflow: auto;
        border: 1px solid #ddd;
    }
    .flow-step {
        position: absolute;
        width: 150px;
        height: auto;
        background-color: white;
        border: 2px solid #1e88e5;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: move;
        z-index: 10;
    }
    .flow-step.start {
        border-color: #43a047;
    }
    .flow-step.end {
        border-color: #e53935;
    }
    .flow-step.view {
        border-color: #1e88e5;
    }
    .flow-step.function {
        border-color: #8e24aa;
    }
    .flow-step.if {
        border-color: #fb8c00;
    }
    .flow-step-header {
        font-weight: bold;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
        margin-bottom: 5px;
    }
    .flow-step-content {
        font-size: 0.85rem;
    }
    .flow-connection {
        position: absolute;
        z-index: 5;
        pointer-events: none;
    }
    .flow-step.selected {
        box-shadow: 0 0 0 2px #007bff;
    }
    .connection-btn {
        position: absolute;
        bottom: -10px;
        width: 20px;
        height: 20px;
        background-color: #2196F3;
        border-radius: 50%;
        cursor: pointer;
        z-index: 20;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .connection-btn.next {
        right: calc(50% - 10px);
    }
    .connection-btn.true {
        right: calc(75% - 10px);
    }
    .connection-btn.false {
        right: calc(25% - 10px);
    }
    .connection-line {
        position: absolute;
        height: 2px;
        background-color: #888;
        transform-origin: left center;
        pointer-events: none;
        z-index: 5;
    }
    .connection-line::after {
        content: '';
        position: absolute;
        right: 0;
        top: -4px;
        width: 0;
        height: 0;
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
        border-left: 8px solid #888;
    }
    .connection-line.true {
        background-color: #4CAF50;
    }
    .connection-line.true::after {
        border-left-color: #4CAF50;
    }
    .connection-line.false {
        background-color: #F44336;
    }
    .connection-line.false::after {
        border-left-color: #F44336;
    }
    .connection-mode-active #flow-designer-canvas {
        cursor: crosshair;
    }
    #connection-instruction {
        display: none;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 8px 15px;
        border-radius: 4px;
        z-index: 1000;
    }
    .connection-mode-active #connection-instruction {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">طراح جریان کار: {{ template.name }}</h4>
                    <div>
                        <a href="{% url 'app1:generate_flow_code' template.id %}" class="btn btn-success">
                            <i class="bi bi-code-slash me-2"></i>
                            تولید کد
                        </a>
                        <a href="{% url 'app1:flow_template_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-right me-2"></i>
                            بازگشت به لیست
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <p><strong>نوع:</strong> {{ template.get_flow_type_display }} | <strong>کلاس فرآیند:</strong> {{ template.process_class }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">نمودار جریان کار</h5>
                </div>
                <div class="card-body">
                    <div id="flow-designer-canvas">
                        {% for step in steps %}
                        <div id="step-{{ step.id }}" class="flow-step {{ step.step_type }}" 
                             data-id="{{ step.id }}" 
                             data-type="{{ step.step_type }}"
                             style="left: {{ step.x_coord }}px; top: {{ step.y_coord }}px;">
                            <div class="flow-step-header">{{ step.name }}</div>
                            <div class="flow-step-content">{{ step.get_step_type_display }}</div>
                            {% if step.step_type != 'end' %}
                                {% if step.step_type == 'if' %}
                                    <div class="connection-btn true" data-connection-type="true" title="مسیر صحیح">T</div>
                                    <div class="connection-btn false" data-connection-type="false" title="مسیر اشتباه">F</div>
                                {% else %}
                                    <div class="connection-btn next" data-connection-type="next" title="مرحله بعدی">→</div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        {# Draw connection lines #}
                        {% for step in steps %}
                            {% if step.next_step %}
                                <div class="connection-line"
                                     data-from="{{ step.id }}"
                                     data-to="{{ step.next_step.id }}"
                                     data-type="next"></div>
                            {% endif %}
                            {% if step.branch_true %}
                                <div class="connection-line true"
                                     data-from="{{ step.id }}"
                                     data-to="{{ step.branch_true.id }}"
                                     data-type="true"></div>
                            {% endif %}
                            {% if step.branch_false %}
                                <div class="connection-line false"
                                     data-from="{{ step.id }}"
                                     data-to="{{ step.branch_false.id }}"
                                     data-type="false"></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">افزودن مرحله</h5>
                </div>
                <div class="card-body">
                    <form id="step-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="step-name" class="form-label">نام مرحله</label>
                            <input type="text" class="form-control" id="step-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="step-type" class="form-label">نوع مرحله</label>
                            <select class="form-select" id="step-type" required>
                                <option value="view">نمایش فرم</option>
                                <option value="function">اجرای تابع</option>
                                <option value="if">شرط</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="button" id="add-step-btn" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>
                                افزودن مرحله
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">تنظیمات مرحله</h5>
                </div>
                <div class="card-body" id="step-settings">
                    <p class="text-muted">برای ویرایش، روی یک مرحله کلیک کنید.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="connection-instruction">
    انتخاب مرحله مقصد برای ایجاد ارتباط. برای لغو، در فضای خالی کلیک کنید.
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('flow-designer-canvas');
        const addStepBtn = document.getElementById('add-step-btn');
        const stepSettings = document.getElementById('step-settings');
        const steps = Array.from(document.querySelectorAll('.flow-step'));
        let selectedStep = null;
        let isConnecting = false;
        let connectionSource = null;
        let connectionType = null;
        
        // Draw initial connections
        drawAllConnections();

        // Make steps draggable
        steps.forEach(step => {
            makeDraggable(step);
            // Add click handler
            step.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // If in connection mode, handle connection
                if (isConnecting) {
                    if (step !== connectionSource) {
                        createConnection(connectionSource, step, connectionType);
                    }
                    exitConnectionMode();
                    return;
                }
                
                selectStep(step);
            });
        });
        
        // Add connection handlers
        document.querySelectorAll('.connection-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const step = e.target.closest('.flow-step');
                startConnection(step, e.target.dataset.connectionType);
            });
        });

        // Handle click on empty canvas
        canvas.addEventListener('click', function(e) {
            if (e.target === canvas) {
                if (isConnecting) {
                    exitConnectionMode();
                    return;
                }
                deselectStep();
            }
        });

        // Add new step with connections
        addStepBtn.addEventListener('click', function() {
            const name = document.getElementById('step-name').value;
            const type = document.getElementById('step-type').value;
            
            if (!name) return alert('لطفا نام مرحله را وارد کنید.');
            
            // Default position in middle of visible canvas
            const x = Math.max(100, canvas.clientWidth / 2 - 75);
            const y = Math.max(100, canvas.clientHeight / 2 - 75);
            
            // Get CSRF token from the form
            const csrfToken = document.querySelector('#step-form [name=csrfmiddlewaretoken]').value;
            
            // Create form data for the request
            const formData = new FormData();
            formData.append('name', name);
            formData.append('step_type', type);
            formData.append('x_coord', x);
            formData.append('y_coord', y);
            
            // Show loading indicator
            addStepBtn.disabled = true;
            addStepBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال پردازش...';
            
            console.log('Sending step creation request:', {name, type, x, y});
            
            // AJAX request to create step
            fetch(`{% url 'app1:flow_step_create' template.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Step creation response:', data);
                if (data.success) {
                    // Add new step to canvas
                    const newStep = document.createElement('div');
                    newStep.id = `step-${data.step_id}`;
                    newStep.className = `flow-step ${type}`;
                    newStep.dataset.id = data.step_id;
                    newStep.dataset.type = type;
                    newStep.style.left = `${x}px`;
                    newStep.style.top = `${y}px`;
                    newStep.innerHTML = `
                        <div class="flow-step-header">${name}</div>
                        <div class="flow-step-content">${getStepTypeDisplay(type)}</div>
                    `;
                    
                    // Add connection buttons
                    if (type !== 'end') {
                        if (type === 'if') {
                            newStep.innerHTML += `
                                <div class="connection-btn true" data-connection-type="true" title="مسیر صحیح">T</div>
                                <div class="connection-btn false" data-connection-type="false" title="مسیر اشتباه">F</div>
                            `;
                        } else {
                            newStep.innerHTML += `
                                <div class="connection-btn next" data-connection-type="next" title="مرحله بعدی">→</div>
                            `;
                        }
                        
                        // Add connection handlers
                        newStep.querySelectorAll('.connection-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                startConnection(newStep, e.target.dataset.connectionType);
                            });
                        });
                    }
                    
                    canvas.appendChild(newStep);
                    makeDraggable(newStep);
                    
                    // Reset form
                    document.getElementById('step-name').value = '';
                    
                    // Select new step
                    selectStep(newStep);
                } else {
                    alert('خطا در ایجاد مرحله: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error creating step:', error);
                alert('خطا در ایجاد مرحله: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                addStepBtn.disabled = false;
                addStepBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i> افزودن مرحله';
            });
        });

        // Function to start a connection
        function startConnection(sourceStep, type) {
            // Exit if already connecting
            if (isConnecting) {
                exitConnectionMode();
                return;
            }
            
            // Set connection mode
            isConnecting = true;
            connectionSource = sourceStep;
            connectionType = type;
            
            // Add visual indication
            document.body.classList.add('connection-mode-active');
            connectionSource.classList.add('connection-source');
        }
        
        // Function to exit connection mode
        function exitConnectionMode() {
            isConnecting = false;
            document.body.classList.remove('connection-mode-active');
            if (connectionSource) {
                connectionSource.classList.remove('connection-source');
                connectionSource = null;
            }
            connectionType = null;
        }
        
        // Function to create connection between steps
        function createConnection(source, target, type) {
            if (!source || !target || !type) return;
            
            const sourceId = source.dataset.id;
            const targetId = target.dataset.id;
            const csrfToken = document.querySelector('#step-form [name=csrfmiddlewaretoken]').value;
            
            // Check if target is start step
            if (target.dataset.type === 'start') {
                alert('نمی‌توان به مرحله شروع متصل شد.');
                return;
            }
            
            // Check if source is end step
            if (source.dataset.type === 'end') {
                alert('نمی‌توان از مرحله پایان متصل شد.');
                return;
            }
            
            // Send request to update connection
            fetch('{% url "app1:flow_connection_update" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `source_id=${sourceId}&target_id=${targetId}&connection_type=${type}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove existing connection of this type
                    removeConnection(sourceId, type);
                    
                    // Create new connection line
                    const lineElement = document.createElement('div');
                    lineElement.className = `connection-line ${type !== 'next' ? type : ''}`;
                    lineElement.dataset.from = sourceId;
                    lineElement.dataset.to = targetId;
                    lineElement.dataset.type = type;
                    canvas.appendChild(lineElement);
                    
                    // Update the connection line position
                    updateConnectionLine(lineElement);
                    
                    console.log(`Connection created from ${sourceId} to ${targetId} of type ${type}`);
                } else {
                    alert('خطا در ایجاد ارتباط: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error creating connection:', error);
                alert('خطا در ایجاد ارتباط');
            });
        }
        
        // Function to remove a connection
        function removeConnection(sourceId, type) {
            const selector = `.connection-line[data-from="${sourceId}"][data-type="${type}"]`;
            const existingLine = document.querySelector(selector);
            if (existingLine) {
                existingLine.remove();
            }
        }
        
        // Function to update a connection line position
        function updateConnectionLine(lineElement) {
            const sourceId = lineElement.dataset.from;
            const targetId = lineElement.dataset.to;
            
            const sourceElement = document.querySelector(`.flow-step[data-id="${sourceId}"]`);
            const targetElement = document.querySelector(`.flow-step[data-id="${targetId}"]`);
            
            if (!sourceElement || !targetElement) return;
            
            const sourceBounds = sourceElement.getBoundingClientRect();
            const targetBounds = targetElement.getBoundingClientRect();
            const canvasBounds = canvas.getBoundingClientRect();
            
            // Calculate source and target positions relative to canvas
            const sourceX = sourceElement.offsetLeft + sourceElement.offsetWidth / 2;
            const sourceY = sourceElement.offsetTop + sourceElement.offsetHeight - 10; // Bottom of source
            const targetX = targetElement.offsetLeft + targetElement.offsetWidth / 2;
            const targetY = targetElement.offsetTop; // Top of target
            
            // Calculate line length and angle
            const dx = targetX - sourceX;
            const dy = targetY - sourceY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Set line position
            lineElement.style.left = `${sourceX}px`;
            lineElement.style.top = `${sourceY}px`;
            lineElement.style.width = `${length}px`;
            lineElement.style.transform = `rotate(${angle}deg)`;
        }
        
        // Function to update all connection lines
        function updateAllConnections() {
            document.querySelectorAll('.connection-line').forEach(updateConnectionLine);
        }
        
        // Function to draw all connections
        function drawAllConnections() {
            document.querySelectorAll('.connection-line').forEach(updateConnectionLine);
        }

        // Update connection positions when step positions are updated
        function updateStepPosition(element) {
            const stepId = element.dataset.id;
            const x = parseInt(element.style.left);
            const y = parseInt(element.style.top);
            
            fetch(`{% url 'app1:flow_step_update' 0 %}`.replace('0', stepId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('#step-form [name=csrfmiddlewaretoken]').value
                },
                body: `x_coord=${x}&y_coord=${y}`
            })
            .then(response => response.json())
            .catch(error => console.error('Error updating position:', error));
            
            // Update connections related to this step
            document.querySelectorAll(`.connection-line[data-from="${stepId}"], .connection-line[data-to="${stepId}"]`)
                .forEach(updateConnectionLine);
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.addEventListener('mousedown', dragMouseDown);
            
            function dragMouseDown(e) {
                e.preventDefault();
                // Get the mouse cursor position at startup
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.addEventListener('mouseup', closeDragElement);
                document.addEventListener('mousemove', elementDrag);
            }
            
            function elementDrag(e) {
                e.preventDefault();
                // Calculate the new position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // Set the element's new position
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                // Stop moving when mouse button is released
                document.removeEventListener('mouseup', closeDragElement);
                document.removeEventListener('mousemove', elementDrag);
                
                // Save the position in the database
                updateStepPosition(element);
            }
        }

        function selectStep(step) {
            // Deselect previously selected step
            if (selectedStep) {
                selectedStep.classList.remove('selected');
            }
            
            // Select the new step
            selectedStep = step;
            step.classList.add('selected');
            
            // Show settings for the selected step
            showStepSettings(step);
        }

        function deselectStep() {
            if (selectedStep) {
                selectedStep.classList.remove('selected');
                selectedStep = null;
                stepSettings.innerHTML = '<p class="text-muted">برای ویرایش، روی یک مرحله کلیک کنید.</p>';
            }
        }

        function showStepSettings(step) {
            const stepId = step.dataset.id;
            const stepType = step.dataset.type;
            const stepName = step.querySelector('.flow-step-header').textContent;
            
            let settingsHtml = `
                <form id="step-settings-form" data-id="${stepId}">
                    <div class="mb-3">
                        <label for="edit-step-name" class="form-label">نام مرحله</label>
                        <input type="text" class="form-control" id="edit-step-name" value="${stepName}" required>
                    </div>
            `;
            
            if (stepType === 'view') {
                settingsHtml += `
                    <div class="mb-3">
                        <label for="edit-view-class" class="form-label">کلاس نمایش</label>
                        <select class="form-select" id="edit-view-class">
                            {% for view_class in view_classes %}
                            <option value="{{ view_class }}">{{ view_class }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-view-fields" class="form-label">فیلدها (با کاما جدا کنید)</label>
                        <input type="text" class="form-control" id="edit-view-fields">
                        <small class="form-text text-muted">فیلدهای موجود: {% for field in process_fields %}{{ field }}, {% endfor %}</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit-auto-permission" checked>
                        <label class="form-check-label" for="edit-auto-permission">
                            ایجاد خودکار دسترسی
                        </label>
                    </div>
                `;
            } else if (stepType === 'function') {
                settingsHtml += `
                    <div class="mb-3">
                        <label for="edit-function-name" class="form-label">نام تابع</label>
                        <input type="text" class="form-control" id="edit-function-name">
                    </div>
                `;
            } else if (stepType === 'if') {
                settingsHtml += `
                    <div class="mb-3">
                        <label for="edit-condition-type" class="form-label">نوع شرط</label>
                        <select class="form-select" id="edit-condition-type">
                            <option value="field_check">بررسی مقدار فیلد</option>
                            <option value="python_code">کد پایتون</option>
                        </select>
                    </div>
                    <div id="field-check-options">
                        <div class="mb-3">
                            <label for="edit-condition-field" class="form-label">فیلد</label>
                            <select class="form-select" id="edit-condition-field">
                                {% for field in process_fields %}
                                <option value="{{ field }}">{{ field }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-condition-value" class="form-label">مقدار</label>
                            <input type="text" class="form-control" id="edit-condition-value">
                        </div>
                    </div>
                    <div id="python-code-options" style="display:none;">
                        <div class="mb-3">
                            <label for="edit-condition-code" class="form-label">کد شرط</label>
                            <textarea class="form-control" id="edit-condition-code" rows="3"></textarea>
                            <small class="form-text text-muted">مثال: lambda activation: activation.process.is_approved</small>
                        </div>
                    </div>
                `;
            }
            
            // Don't show delete button for start and end steps
            if (stepType !== 'start' && stepType !== 'end') {
                settingsHtml += `
                    <div class="d-flex gap-2 mt-3">
                        <button type="button" id="update-step-btn" class="btn btn-primary flex-grow-1">
                            <i class="bi bi-save me-2"></i>
                            ذخیره تغییرات
                        </button>
                        <button type="button" id="delete-step-btn" class="btn btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            } else {
                settingsHtml += `
                    <div class="d-grid mt-3">
                        <button type="button" id="update-step-btn" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>
                            ذخیره تغییرات
                        </button>
                    </div>
                `;
            }
            
            settingsHtml += `</form>`;
            
            stepSettings.innerHTML = settingsHtml;
            
            // Add event listeners for the settings form
            const updateBtn = document.getElementById('update-step-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', function() {
                    updateStepSettings(step);
                });
            }
            
            const deleteBtn = document.getElementById('delete-step-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteStep(step);
                });
            }
            
            // Condition type change handler
            const conditionType = document.getElementById('edit-condition-type');
            if (conditionType) {
                conditionType.addEventListener('change', function() {
                    const fieldCheckOptions = document.getElementById('field-check-options');
                    const pythonCodeOptions = document.getElementById('python-code-options');
                    
                    if (this.value === 'field_check') {
                        fieldCheckOptions.style.display = 'block';
                        pythonCodeOptions.style.display = 'none';
                    } else {
                        fieldCheckOptions.style.display = 'none';
                        pythonCodeOptions.style.display = 'block';
                    }
                });
            }
        }

        function updateStepSettings(step) {
            const stepId = step.dataset.id;
            const stepType = step.dataset.type;
            
            // Get CSRF token
            const csrfToken = document.querySelector('#step-form [name=csrfmiddlewaretoken]').value;
            
            // Create form data
            let formData = new FormData();
            formData.append('name', document.getElementById('edit-step-name').value);
            
            if (stepType === 'view') {
                formData.append('view_class', document.getElementById('edit-view-class').value);
                formData.append('view_fields', document.getElementById('edit-view-fields').value);
                formData.append('auto_create_permission', document.getElementById('edit-auto-permission').checked ? 'on' : 'off');
            } else if (stepType === 'function') {
                formData.append('function_name', document.getElementById('edit-function-name').value);
            } else if (stepType === 'if') {
                const conditionType = document.getElementById('edit-condition-type').value;
                formData.append('condition_type', conditionType);
                
                if (conditionType === 'field_check') {
                    formData.append('condition_field', document.getElementById('edit-condition-field').value);
                    formData.append('condition_value', document.getElementById('edit-condition-value').value);
                } else {
                    formData.append('condition_code', document.getElementById('edit-condition-code').value);
                }
            }
            
            fetch(`{% url 'app1:flow_step_update' 0 %}`.replace('0', stepId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the step display
                    step.querySelector('.flow-step-header').textContent = document.getElementById('edit-step-name').value;
                    alert('تغییرات با موفقیت ذخیره شد.');
                } else {
                    alert('خطا در بروزرسانی: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteStep(step) {
            if (!confirm('آیا از حذف این مرحله اطمینان دارید؟')) return;
            
            const stepId = step.dataset.id;
            
            fetch(`{% url 'app1:flow_step_delete' 0 %}`.replace('0', stepId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the step from canvas
                    step.remove();
                    deselectStep();
                } else {
                    alert('خطا در حذف مرحله: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function getStepTypeDisplay(type) {
            const types = {
                'start': 'شروع',
                'end': 'پایان',
                'view': 'نمایش فرم',
                'function': 'اجرای تابع',
                'if': 'شرط'
            };
            return types[type] || type;
        }
    });
</script>
{% endblock %} 