{% extends 'app2/base.html' %}
{% load static %}

{% block title %}Oracle Query Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'app2:oracle_dashboard' %}">Oracle Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'app2:oracle_query_interface' %}">Query Interface</a></li>
                    <li class="breadcrumb-item active">Results</li>
                </ol>
            </nav>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-table"></i> Query Results</h3>
                </div>
                <div class="card-body">
                    <!-- Query Display -->
                    <div class="mb-3">
                        <h5>Executed Query:</h5>
                        <pre class="bg-light p-3 border rounded">{{ query }}</pre>
                    </div>
                    
                    <!-- Results Count -->
                    <div class="mb-3">
                        <span class="badge badge-info">{{ results|length }} row(s) returned</span>
                        <a href="{% url 'app2:oracle_query_interface' %}" class="btn btn-sm btn-secondary ml-2">
                            <i class="fas fa-arrow-left"></i> Back to Query Interface
                        </a>
                        <button class="btn btn-sm btn-success ml-2" onclick="exportToCSV()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    
                    <!-- Results Table -->
                    {% if results %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="results-table">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>#</th>
                                        {% for key in results.0.keys %}
                                            <th>{{ key }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in results %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            {% for value in row.values %}
                                                <td>
                                                    {% if value is None %}
                                                        <span class="text-muted font-italic">NULL</span>
                                                    {% elif value == "" %}
                                                        <span class="text-muted font-italic">Empty</span>
                                                    {% else %}
                                                        {{ value }}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No results returned from the query.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    const table = document.getElementById('results-table');
    let csv = [];
    
    // Get headers (skip the # column)
    const headers = [];
    const headerRow = table.querySelector('thead tr');
    for (let i = 1; i < headerRow.cells.length; i++) {
        headers.push(headerRow.cells[i].textContent);
    }
    csv.push(headers.join(','));
    
    // Get data rows (skip the # column)
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const rowData = [];
        for (let i = 1; i < row.cells.length; i++) {
            let cellData = row.cells[i].textContent;
            // Handle special cases
            if (cellData === 'NULL' || cellData === 'Empty') {
                cellData = '';
            }
            // Escape commas and quotes
            if (cellData.includes(',') || cellData.includes('"')) {
                cellData = '"' + cellData.replace(/"/g, '""') + '"';
            }
            rowData.push(cellData);
        }
        csv.push(rowData.join(','));
    });
    
    // Download CSV
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'oracle_query_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Add table styling
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('results-table');
    if (table) {
        // Add hover effect to rows
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    }
});
</script>
{% endblock %} 